<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä ‚Äî –†–µ–π—Ç–∏–Ω–≥ —Å –∏–º–µ–Ω–µ–º/–∫–æ–º–∞–Ω–¥–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body { background: linear-gradient(180deg, #f8fafc, #ffffff); } </style>
</head>
<body class="text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">–¢—Ä–µ–Ω–∞–∂—ë—Ä ‚Äî —Ä–µ–π—Ç–∏–Ω–≥ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h1>
      <p class="text-slate-600">–ò–º—è/–ö–æ–º–∞–Ω–¥–∞ ‚Üí –ø–æ–ø—ã—Ç–∫–∞ (–æ—á–∫–∏, –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å, –≤—Ä–µ–º—è) ‚Üí ¬´–∂–∏–≤–æ–π¬ª —Ä–µ–π—Ç–∏–Ω–≥</p>
    </header>

    <!-- Profile -->
    <section class="rounded-2xl border bg-white p-4 mb-6">
      <div class="flex flex-col md:flex-row md:items-end md:gap-4 gap-2">
        <div class="flex-1">
          <label class="block text-sm mb-1">–ò–º—è/–Ω–∏–∫</label>
          <input id="name" class="w-full border rounded-xl px-3 py-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê–Ω–Ω–∞ –ö."/>
        </div>
        <div class="flex-1">
          <label class="block text-sm mb-1">–ö–æ–º–∞–Ω–¥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input id="team" class="w-full border rounded-xl px-3 py-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –®–∫–æ–ª–∞ ‚Ññ7"/>
        </div>
        <button id="saveProfile" class="px-4 py-2 rounded-xl border">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
      <div class="text-sm mt-2 opacity-70">–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.</div>
    </section>

    <!-- Test mock (–ø–æ–¥–∫–ª—é—á–∏ —Å–≤–æ–π —Ç–µ—Å—Ç –∏ –∑–∞—Å—á–∏—Ç—ã–≤–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã/–≤—Ä–µ–º—è) -->
    <section class="rounded-2xl border bg-white p-4 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">–¢–µ—Å—Ç (–º–∞–∫–µ—Ç): 5 –≤–æ–ø—Ä–æ—Å–æ–≤</div>
          <div class="text-sm opacity-70">–ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç. –ù–∏–∂–µ ‚Äî —Ç–∞–π–º–µ—Ä –∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª.</div>
        </div>
        <div class="text-sm">‚è± –û—Å—Ç–∞–ª–æ—Å—å: <span id="timer" class="font-semibold">60</span> c</div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="start" class="px-3 py-2 rounded-xl border">–°—Ç–∞—Ä—Ç</button>
        <button id="answerGood" class="px-3 py-2 rounded-xl border">–û—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ (+1)</button>
        <button id="answerBad" class="px-3 py-2 rounded-xl border">–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–µ–≤–µ—Ä–Ω–æ</button>
        <button id="finish" class="px-3 py-2 rounded-xl border">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      </div>
      <div class="mt-3 text-sm">–í–µ—Ä–Ω–æ —Å–µ–π—á–∞—Å: <span id="correctNow" class="font-medium">0</span> / <span id="totalNow">5</span></div>
      <div class="mt-3">
        <button id="send" class="px-4 py-2 rounded-xl bg-black text-white">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ä–µ–π—Ç–∏–Ω–≥</button>
      </div>
      <div id="sendStatus" class="mt-2 text-sm opacity-70"></div>
    </section>

    <!-- Rating -->
    <section class="rounded-2xl border bg-white p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">üèÜ –†–µ–π—Ç–∏–Ω–≥ (—Ç–æ–ø-50)</div>
        <div class="text-sm opacity-70">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –æ—á–∫–∏ ‚Üì, –ø—Ä–∏ —Ä–∞–≤–Ω—ã—Ö ‚Äî –≤—Ä–µ–º—è ‚Üë, —Å–≤–µ–∂–∏–µ –≤—ã—à–µ</div>
      </div>
      <div class="overflow-x-auto">
        <table class="text-sm w-full">
          <thead class="text-left">
            <tr>
              <th class="px-2 py-1">#</th>
              <th class="px-2 py-1">–ò–º—è</th>
              <th class="px-2 py-1">–ö–æ–º–∞–Ω–¥–∞</th>
              <th class="px-2 py-1">–û—á–∫–∏</th>
              <th class="px-2 py-1">–í–µ—Ä–Ω–æ</th>
              <th class="px-2 py-1">–í—Ä–µ–º—è</th>
              <th class="px-2 py-1">–ö–æ–≥–¥–∞</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="ratingStatus" class="mt-2 text-sm opacity-70"></div>
    </section>

    <footer class="mt-8 text-sm opacity-70">
      <div>–ï—Å–ª–∏ –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω <code>firebaseConfig</code>, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ (–±–µ–∑ –æ–±–ª–∞–∫–∞).</div>
    </footer>
  </div>

  <!-- Core logic (–¥–µ–º–æ + Firebase –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏) -->
  <script type="module">
    // ====== OPTIONAL FIREBASE (–í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì –ù–ò–ñ–ï) ======
    // –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ.
   const firebaseConfig = {
  apiKey: "AIzaSyCj3uUUqGKZ2CalH-v3So6OjU_-eZH7tUc",
  authDomain: "pp10-79133.firebaseapp.com",
  projectId: "pp10-79133",
  storageBucket: "pp10-79133.firebasestorage.app",
  messagingSenderId: "179048880378",
  appId: "1:179048880378:web:0510340ddfb5f639b01143",
  measurementId: "G-QCX9BD9KY2"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    let useFirebase = Object.values(firebaseConfig).some(v => String(v||"").trim().length > 0);
    let fb = null;

    if (useFirebase) {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js");
        const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js");
        const { getFirestore, serverTimestamp, collection, addDoc, query, orderBy, limit, onSnapshot } = await import("https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js");

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        await signInAnonymously(auth);

        const db = getFirestore(app);
        fb = { db, serverTimestamp, collection, addDoc, query, orderBy, limit, onSnapshot };
        document.getElementById('ratingStatus').textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–æ —Å Firebase. –†–µ–π—Ç–∏–Ω–≥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.";
      } catch (e) {
        console.warn("Firebase init error:", e);
        useFirebase = false;
        document.getElementById('ratingStatus').textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase ‚Äî –≤–∫–ª—é—á—ë–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Ä–µ–∂–∏–º.";
      }
    } else {
      document.getElementById('ratingStatus').textContent = "Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Ä–µ–∂–∏–º.";
    }

    // ====== DEMO state (–ª–æ–∫–∞–ª—å–Ω–∞—è –∏–º–∏—Ç–∞—Ü–∏—è) ======
    let startTs = null;
    let timerId = null;
    let left = 60;
    const total = 5;
    let correct = 0;
    const localAttempts = []; // –¥–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞

    const el = (id) => document.getElementById(id);
    const fmtSec = (ms) => Math.round((ms||0)/1000) + ' c';

    // Profile (–ª–æ–∫–∞–ª—å–Ω–æ)
    const PROFILE_KEY = "rating_profile_v1";
    const saved = JSON.parse(localStorage.getItem(PROFILE_KEY)||"{}");
    if (saved.name) el('name').value = saved.name;
    if (saved.team) el('team').value = saved.team;
    el('saveProfile').onclick = () => {
      const name = el('name').value.trim();
      const team = el('team').value.trim();
      localStorage.setItem(PROFILE_KEY, JSON.stringify({ name, team }));
      alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    };

    // Test controls
    el('start').onclick = () => {
      correct = 0;
      left = 60;
      el('correctNow').textContent = correct;
      el('timer').textContent = left;
      startTs = performance.now();
      timerId && clearInterval(timerId);
      timerId = setInterval(() => {
        left = Math.max(0, left - 1);
        el('timer').textContent = left;
        if (left <= 0) { clearInterval(timerId); }
      }, 1000);
    };
    el('answerGood').onclick = () => {
      if (left > 0 && startTs) {
        correct = Math.min(total, correct + 1);
        el('correctNow').textContent = correct;
      }
    };
    el('answerBad').onclick = () => { /* –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º */ };
    el('finish').onclick = () => {
      left = 0;
      el('timer').textContent = left;
      timerId && clearInterval(timerId);
    };

    // Send result
    el('send').onclick = async () => {
      const name = el('name').value.trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏';
      const team = el('team').value.trim() || '';
      if (!startTs) { alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –°—Ç–∞—Ä—Ç'); return; }

      const durationMs = Math.max(0, performance.now() - startTs);
      const points = correct * 5 + (left > 0 ? 5 : 0); // –ø—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª—ã

      el('sendStatus').textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

      if (useFirebase) {
        try {
          const { db, serverTimestamp, collection, addDoc } = fb;
          await addDoc(collection(db, 'attempts'), {
            name, team, points, correct, total, durationMs, createdAt: serverTimestamp()
          });
          el('sendStatus').textContent = "‚úî –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥ (Firebase).";
        } catch (e) {
          console.error(e);
          el('sendStatus').textContent = "‚ö† –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Firebase.";
        }
      } else {
        localAttempts.push({ name, team, points, correct, total, durationMs, createdAt: new Date() });
        renderLocalTable();
        el('sendStatus').textContent = "‚úî –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (–¥–µ–º–æ).";
      }
    };

    // Rating table
    function renderLocalTable() {
      const arr = localAttempts.slice().sort((a,b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (a.durationMs !== b.durationMs) return a.durationMs - b.durationMs;
        return b.createdAt - a.createdAt;
      }).slice(0,50);
      renderRows(arr.map((a,i)=>({...a, rank:i+1})));
    }

    function renderRows(rows) {
      const html = rows.map(r => `
        <tr class="border-t">
          <td class="px-2 py-1">${r.rank}</td>
          <td class="px-2 py-1">${String(r.name).replace(/</g,'&lt;')}</td>
          <td class="px-2 py-1">${r.team||'‚Äî'}</td>
          <td class="px-2 py-1">${r.points}</td>
          <td class="px-2 py-1">${r.correct}/${r.total}</td>
          <td class="px-2 py-1">${fmtSec(r.durationMs)}</td>
          <td class="px-2 py-1">${r.createdAt instanceof Date ? r.createdAt.toLocaleString('ru-RU') : ''}</td>
        </tr>
      `).join('');
      el('tbody').innerHTML = html || `<tr><td colspan="7" class="px-2 py-3 opacity-70">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ø—ã—Ç–æ–∫</td></tr>`;
    }

    if (useFirebase) {
      const { db, query, collection, orderBy, limit, onSnapshot } = fb;
      const q = query(
        collection(db, 'attempts'),
        orderBy('points', 'desc'),
        orderBy('durationMs', 'asc'),
        orderBy('createdAt', 'desc'),
        limit(50)
      );
      onSnapshot(q, (snap) => {
        const rows = [];
        let i = 1;
        snap.forEach(doc => {
          const a = doc.data();
          rows.push({
            rank: i++,
            name: a.name || '‚Äî',
            team: a.team || '',
            points: a.points || 0,
            correct: a.correct || 0,
            total: a.total || 0,
            durationMs: a.durationMs || 0,
            createdAt: a.createdAt?.toDate ? a.createdAt.toDate() : new Date()
          });
        });
        renderRows(rows);
      });
    } else {
      renderLocalTable();
    }
  </script>
</body>
</html>
